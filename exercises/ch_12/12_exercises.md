# Упражнения

Все задания и вспомогательные файлы можно скачать [тут](https://github.com/natenka/PyNEng/blob/master/exercises.zip) (так будет удобнее их выполнять).

> Если в заданиях раздела есть задания с буквами (например, 5.2a), то можно выполнить сначала задания без букв, а затем с буквами. Задания с буквами, как правило, немного сложнее заданий без букв и развивают/усложняют идею в соответствующем задании без буквы.

> Например, если в разделе есть задания: 5.1, 5.2, 5.2a, 5.2b, 5.3, 5.3a.

> Сначала, можно выполнить задания 5.1, 5.2, 5.3. А затем 5.2a, 5.2b, 5.3a.

> Однако, если задания с буквами получается сделать сразу, можно делать их по порядку.

### Задание 12.1

Создать функцию send_show_command.

Функция подключается по SSH к устройствам из списка, и выполняет  команду
на основании переданных аргументов:
* devices_list - список словарей с параметрами подключения к устройствам, которым надо передать команды
* command - команда, которую надо выполнить

Функция возвращает словарь с результатами выполнения команды:
* ключ - IP устройства
* значение - результат выполнения команды

Проверить работу функции на примере:
* устройств из файла devices.yaml (для этого надо считать информацию из файла)
* и команды command

```python
import netmiko

command = "sh ip int br"

def send_show_command(device_list, command):
    """
    Функция подключается по SSH к устройствам из списка, и выполняет команду
    на основании переданных аргументов:
    - devices_list - список словарей с параметрами подключения к устройствам, которым надо передать команды
    - command - команда, которую надо выполнить
    
    Функция возвращает словарь с результатами выполнения команды:
        - ключ - IP устройства
        - значение - результат выполнения команды
    """
```

### Задание 12.2

Создать функцию send_config_commands

Функция подключается по SSH к устройствам из списка, и выполняет перечень команд в конфигурационном режиме
на основании переданных аргументов:
* devices_list - список словарей с параметрами подключения к устройствам, которым надо передать команды
* config_commands - список команд, которые надо выполнить

Функция возвращает словарь с результатами выполнения команды:
* ключ - IP устройства
* значение - результат выполнения команды

Проверить работу функции на примере:
* устройств из файла devices.yaml (для этого надо считать информацию из файла)
* и списка команд commands

```python

import netmiko

commands = [ 'logging 10.255.255.1',
             'logging buffered 20010',
             'no logging console' ]

def send_config_commands(device_list, config_commands):
    """
    Функция подключается по SSH к устройствам из списка, и выполняет show команду
    на основании переданных аргументов:
        - devices_list - список словарей с параметрами подключения к устройствам, которым надо передать команды
        - config_commands - список команд, которые надо выполнить
    
    Функция возвращает словарь с результатами выполнения команды:
        - ключ - IP устройства
        - значение - результат выполнения команды
    """


```

### Задание 12.2a

Дополнить функцию send_config_commands из задания 12.2

Добавить аргумент output, который контролирует будет ли результат выполнения команд выводится функцией.
По умолчанию, результат должен выводиться.


### Задание 12.2b

Дополнить функцию send_config_commands из задания 12.2a или 12.2

Добавить проверку на ошибки:
* При выполнении команд, скрипт должен проверять результат на такие ошибки:
 * Invalid input detected, Incomplete command, Ambiguous command

Если при выполнении какой-то из команд возникла ошибка,
функция должна печатать сообщение на стандартный поток вывода с информацией
о том, какая ошибка возникла, при выполнении какой команды и на каком устройстве.

Проверить функцию на команде с ошибкой.



### Задание 12.3

Создать функцию send_commands.

Функция ожидает аргументы:
* devices_list - список словарей с параметрами подключения к устройствам, которым надо передать команды один из аргументов с командами:
 * show - одна команда show (строка)
 * filename - имя файла, в котором находятся команды, которые надо выполнить (строка)
 * config - список с командами, которые надо выполнить в конфигурационном режиме

В зависимости от того, какой аргумент был передан, функция вызывает разные функции внутри.

Далее комбинация из аргумента и соответствующей функции:
* show -- функция send_show_command из задания 12.1
* config -- функция send_config_commands из задания 12.2, 12.2a или 12.2b
* filename -- функция send_commands_from_file (ее также надо написать по аналогии с предыдущими)

Функция send_commands возвращает словарь с результатами выполнения команды:
* ключ - IP устройства
* значение - результат выполнения команды

Проверить работу функции на примере:
* устройств из файла devices.yaml (для этого надо считать информацию из файла)
* и различных комбинация аргумента с командами:
    * списка команд commands
    * команды command
    * файла config.txt

```python
from netmiko import ConnectHandler

commands = [ 'logging 10.255.255.1',
             'logging buffered 20010',
             'no logging console' ]
command = "sh ip int br"


def send_show_command(device_list, show_command):

def send_config_commands(device_list, config_commands, output=True):

def send_commands(device_list, config=[], show='', filename=''):

```

### Задание 12.4

В задании используется пример из раздела про [модуль threading](book/chapter12/5a_threading.md).

Переделать пример таким образом, чтобы:
* функция connect_ssh не выводила результат выполнения команды на стандартный поток вывода, а возвращала вывод.
* пример надо изменить так, чтобы в результате выполнение команды на всех устройствах, возвращался словарь, где:
 * ключ - IP-адрес устройства
 * значение - результат вывода команды


Пример из раздела:
```python
from netmiko import ConnectHandler
import sys
import yaml
import threading

COMMAND = sys.argv[1]
all_devices = yaml.load(open('devices.yaml'))

def connect_ssh(device_dict, command):
    ssh = ConnectHandler(**device_dict)
    ssh.enable()
    result = ssh.send_command(command)

    print "Connection to device %s" % device_dict['ip']
    print result


def conn_threads(function, devices, command):
    threads = []
    for device in devices:
        th = threading.Thread(target = function, args = (device, command))
        th.start()
        threads.append(th)

    for th in threads:
        th.join()

conn_threads(connect_ssh, all_devices['routers'], COMMAND)
```


### Задание 12.5

Использовать функции полученные в результате выполнения задания 12.4.

Переделать функцию conn_threads таким образом, чтобы с помощью аргумента limit,
можно было указывать сколько подключений будут выполняться параллельно.
По умолчанию, значение аргумента должно быть 2.

Изменить функцию соответственно, так, чтобы параллельных подключений выполнялось столько,
сколько указано в аргументе limit.
