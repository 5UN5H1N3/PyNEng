## TextFSM CLI Table

Благодаря TextFSM, мы можем обрабатывать вывод команд и получать структурированный результат. Но, у нас всё ещё есть ограничения: нам надо вручную прописывать каким шаблоном обрабатывать команды show, каждый раз, когда мы используем TextFSM. Было бы намного удобней иметь какое-то соответствие между командой и шаблоном. Чтобы можно было написать общий скрипт, который выполняет подключения к устройствам, отправляет команды, сам выбирает шаблон и парсит вывод в соответствиее с шаблоном.

Хорошая новость - в TextFSM есть такая возможность.

Для того, чтобы мы могли ей воспользоваться, нам надо создать файл в котором описаны соответствия между командами и шаблонами. В TextFSM он называется index.

Этот файл должен находится в каталоге с шаблонами и должен иметь такой формат:
* первая строка - названия колонок
* каждая следующая строка - это соответствие шаблона команде
* Обязательные колонки, местоположение которых фиксировано (должны быть обязательно первой и последней, соответственно):
 * первая колонка - имена шаблонов
 * последняя колонка - соответствующая команда
   * в этой колонке используется специальный формат, чтобы описать то, что команда может быть написана не полностью
* остальные колонки могут быть любыми
 * например, в примере ниже у нас будут колонки Hostname, Vendor. Они позволяют уточнить информацию об устройстве, чтобы определить какой шаблон использовать.
   * например, команда show version может быть в у оборудования Cisco и HP. Соответственно, только команды недостаточно, чтобы определить какой шаблон использовать. В таком случае, мы можем передать информацию о том, какой тип оборудования используется, вместе с командой, и тогда получится определить правильный шаблон.
* во всех столбцах, кроме первого, поддерживаются регулярные выражения
 * в командах, внутри ```[[]]``` регулярные выражения не поддерживаются

Пример файла index:
```
Template, Hostname, Vendor, Command
cisco_show_cdp_neighbors_detail.template, .*, Cisco, sh[[ow]] cdp ne[[ighbors]] de[[tail]]
cisco_show_clock.template, .*, Cisco, sh[[ow]] clo[[ck]]
cisco_show_ip_int_br.template, .*, Cisco, sh[[ow]] ip int[[erface]] br[[ief]]
cisco_show_ip_route_ospf.template, .*, Cisco, sh[[ow]] ip rou[[te]] o[[spf]]
```

Обратите внимание на то, как записаны команды:
* sh[[ow]] ip int[[erface]] br[[ief]]
 * эта запись будет преобразована в выражение sh((ow)?)? ip int((erface)?)? br((ief)?)?


### Как использовать CLI table

Посмотрим как пользоваться классом clitable и файлом index.

Допустим, в каталоге templates у нас такие шаблоны и файл index:
```
cisco_show_cdp_neighbors_detail.template
cisco_show_clock.template
cisco_show_ip_int_br.template
cisco_show_ip_route_ospf.template
index
```


```
import textfsm.clitable as clitable

# Читаем файл с примером вывода команды show ip route ospf
output_sh_ip_route_ospf = open('examples/sh_ip_route_ospf.txt').read()

cli_table = clitable.CliTable('index', 'templates')

# В словаре ключи - имена столбцов, которые мы определили в файле index
# В данном случае, не обязательно указывать название вендора,
# так как команде sh ip route ospf соответствет только один шаблон. 
attributes = {'Command': 'show ip route ospf' , 'Vendor': 'Cisco'}

# Методу ParseCmd надо передать вывод команды и словарь с параметрами
cli_table.ParseCmd(output_sh_ip_route_ospf, attributes)
print cli_table

print cli_table.FormattedTable()
```

```
$ python textfsm_clitable.py
Network, Mask, Distance, Metric, NextHop
10.0.24.0, /24, 110, 20, ['10.0.12.2']
10.0.34.0, /24, 110, 20, ['10.0.13.3']
10.2.2.2, /32, 110, 11, ['10.0.12.2']
10.3.3.3, /32, 110, 11, ['10.0.13.3']
10.4.4.4, /32, 110, 21, ['10.0.13.3', '10.0.12.2', '10.0.14.4']
10.5.35.0, /24, 110, 20, ['10.0.13.3']

 Network    Mask  Distance  Metric  NextHop
====================================================================
 10.0.24.0  /24   110       20      10.0.12.2
 10.0.34.0  /24   110       20      10.0.13.3
 10.2.2.2   /32   110       11      10.0.12.2
 10.3.3.3   /32   110       11      10.0.13.3
 10.4.4.4   /32   110       21      10.0.13.3, 10.0.12.2, 10.0.14.4
 10.5.35.0  /24   110       20      10.0.13.3
```
